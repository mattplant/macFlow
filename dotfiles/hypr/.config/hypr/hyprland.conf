# --- MacFlow: UTM / VirtIO Config ---

# Display: Dynamic Resizing (The UTM Advantage)
# "preferred" tells Hyprland to use whatever resolution the UTM window is resized to.
# "auto" positions it automatically.
# "2" scales it for Retina (HiDPI). Change to "1" if you want massive screen real estate.
#monitor=,preferred,auto,2
#monitor = Virtual-1, 3840x2160, auto, 2
monitor = , 3840x2160, auto, 2
#monitor = , 2880x1864, auto, 2

# Enable Wayland for Firefox (Critical for VM performance & compatibility)
env = MOZ_ENABLE_WAYLAND,1

# Input: Mac Feel
input {
    kb_layout = us
    follow_mouse = 1

    # Natural Scrolling for Trackpad/Mouse
    natural_scroll = true
    touchpad {
         natural_scroll = true
         tap-to-click = true
    }

    # Sensitivity (Optional tweak for VM mouse feel)
    sensitivity = 0
}

# VM Integration (Critical)
# Fix for invisible cursor on VMs
env = WLR_NO_HARDWARE_CURSORS,1

# Use xwayland for copy/paste stability
xwayland {
    force_zero_scaling = true;
}

# Start SPICE Agent for Clipboard & Auto-Resize
exec-once = systemctl --user start spice-vdagent


# Window Management: Dwindle Layout with Gaps & Borders
general {
    gaps_in = 5
    gaps_out = 10
    border_size = 2
    # Solid Matrix Green to match Waybar
    col.active_border = rgb(00ff99)
    # Inactive: Dark Grey
    col.inactive_border = rgba(595959aa)

    layout = dwindle
}

dwindle {
    pseudotile = true
    preserve_split = true
}

# Performance (Brutalist Mode)
decoration {
    # Disable expensive effects for rock-solid VM performance
    rounding = 5
    blur {
        enabled = false
    }
    shadow {
        enabled = false
    }
}

animations {
    enabled = false
}

misc {
    disable_hyprland_logo = true
    disable_splash_rendering = true
    vfr = true # Variable Frame Rate saves CPU
}


# ----------------------------------------------------------------------
# MACFLOW KEYBINDINGS (macOS Like)
# ----------------------------------------------------------------------
# - "Capture Input Devices" in UTM so we can use macOS-style keybindings
# - To release input device, press: Ctrl + Option (Left)
# ----------------------------------------------------------------------

$mainMod = SUPER # Maps to Command Key on macOS

# --- PREFERRED APPS ---
$term = foot
$browser = firefox
$editor = code

# --- CHEATSHEET BINDING ---
# Launches terminal with:
# -a "macFlow_Help": Sets the App ID to "macFlow_Help" for window rules
# -o: Forces Green text on Black background
# -e: Executes our script
bind = $mainMod, slash, exec, $term -a "macFlow_Help" -o colors.foreground=00ff00 -o colors.background=000000 -e ~/.local/bin/cheatsheet.sh

# Press Super+Shift+C to send text to Mac
bind = $mainMod SHIFT, C, exec, ~/.local/bin/clipboard-export

# --- System ---
bind = $mainMod SHIFT, Q, exit,  # Exit Hyperland

# --- Applications ---
bind = $mainMod, Return, exec, $term      # Terminal (Enter = "Do it")
bind = $mainMod, SPACE, exec, wofi --show drun  # Launcher (Spotlight style)
bind = $mainMod, B, exec, $browser        # Browser
bind = $mainMod, E, exec, $editor         # VS Code

# --- Window Control ---
bind = $mainMod, Q, killactive,           # Close Window
#bind = $mainMod, F, togglefloating, # Toggle Floating
bind = $mainMod CTRL, F, fullscreen, 1     # Maximize (Monocle)

# --- Focus (Arrow Keys) ---
bind = $mainMod, left, movefocus, l
bind = $mainMod, right, movefocus, r
bind = $mainMod, up, movefocus, u
bind = $mainMod, down, movefocus, d

# --- Move Windows (Shift + Arrows) ---
bind = $mainMod SHIFT, left, movewindow, l
bind = $mainMod SHIFT, right, movewindow, r
bind = $mainMod SHIFT, up, movewindow, u
bind = $mainMod SHIFT, down, movewindow, d

# --- Resizing Windows (Alt + Arrows) ---
binde = $mainMod ALT, right, resizeactive, 20 0
binde = $mainMod ALT, left, resizeactive, -20 0
binde = $mainMod ALT, up, resizeactive, 0 -20
binde = $mainMod ALT, down, resizeactive, 0 20

# --- Workspaces ---
# Absolute (Cmd + 1-5)
bind = $mainMod, 1, workspace, 1
bind = $mainMod, 2, workspace, 2
bind = $mainMod, 3, workspace, 3
bind = $mainMod, 4, workspace, 4
bind = $mainMod, 5, workspace, 5

# Move Window to Workspace (Cmd + Shift + 1-5)
bind = $mainMod SHIFT, 1, movetoworkspace, 1
bind = $mainMod SHIFT, 2, movetoworkspace, 2
bind = $mainMod SHIFT, 3, movetoworkspace, 3
bind = $mainMod SHIFT, 4, movetoworkspace, 4
bind = $mainMod SHIFT, 5, movetoworkspace, 5

# Relative Cycling (Cmd + Ctrl + Arrows) - Similar to macOS "Spaces"
bind = $mainMod CTRL, right, workspace, +1
bind = $mainMod CTRL, left, workspace, -1


# ----------------------------------------------------------------------
# MAC-LIKE APP SWITCHER (Cmd + Tab)
# ----------------------------------------------------------------------

# Cycle Next (Forward)
bind = $mainMod, Tab, cyclenext,
bind = $mainMod, Tab, bringactivetotop,

# Cycle Previous (Backward)
bind = $mainMod SHIFT, Tab, cyclenext, prev
bind = $mainMod SHIFT, Tab, bringactivetotop,


# ----------------------------------------------------------------------
# ROBUST SCRATCHPAD
# ----------------------------------------------------------------------

# Toggle Open/Close
bind = $mainMod, S, togglespecialworkspace

# Move active window to scratchpad AND make it float/center
# We use a script here to ensure it resizes and floats before moving
bind = $mainMod SHIFT, S, exec, bash -c "hyprctl dispatch togglefloating active && hyprctl dispatch resizeactive exact 90% 90% && hyprctl dispatch centerwindow && hyprctl dispatch movetoworkspace special"


# ----------------------------------------------------------------------
# VISUAL RULES
# ----------------------------------------------------------------------

# Scratchpad: Yellow Border + Dim Background
windowrulev2 = bordercolor rgb(ffff00), workspace:name:special:special
windowrulev2 = dimaround, workspace:name:special:special

# Maximize/Monocle: Yellow Border
# If a window is fullscreen (mode 1), turn the border yellow
windowrulev2 = bordercolor rgb(ffff00), fullscreen:1

# Cheatsheet: Window Rule
windowrulev2 = float, class:^(macFlow_Help)$
windowrulev2 = center, class:^(macFlow_Help)$
windowrulev2 = size 900 600, class:^(macFlow_Help)$


# ----------------------------------------------------------------------
# AUTOSTART APPLICATIONS
# ----------------------------------------------------------------------

exec-once = dunst
exec-once = /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
exec-once = waybar

# Update Environment (CRITICAL: Must run to populate DBus)
exec-once = dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP

# Host Integration
exec-once = /home/macflow/.local/bin/start-spice

# Mount Mac files (using the function from .bash_profile doesn't work here, use raw command)
# exec-once = sshfs ... (Add your mount command here if you want auto-mount)